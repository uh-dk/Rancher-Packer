#cloud-config
autoinstall:
  version: 1
  early-commands:
    - systemctl stop ssh # otherwise packer tries to connect and exceed max attempts
  locale: en_US.UTF-8
  keyboard:
      layout: de
  timezone: Europe/Berlin
  ntp:
  enabled: true
  ntp_client: chrony
  identity:
      hostname: ubuntu-2204
      username: packerbuilt
      password: '$1$rKxy/hZT$vAZ801S0/UEAEmVKogUdU0' # Password in hashed format
  refresh-installer:
  update: yes
  ssh:
      install-server: yes
      allow-pw: yes
  packages:
    - open-vm-tools
    - network-manager
    - cloud-initramfs-growroot
    - net-tools
    - traceroute
    - original-awk
    - mc
  package_update: true
  package_upgrade: true
  package_reboot_if_required: true
  storage:
  layout:
    name: lvm
  late-commands:
    - echo 'packerbuilt ALL=(ALL) NOPASSWD:ALL' > /target/etc/sudoers.d/packerbuilt;
    - chmod 440 /target/etc/sudoers.d/packerbuilt;
    - sed -i 's/GRUB_CMDLINE_LINUX="\(.*\)"/GRUB_CMDLINE_LINUX="net.ifnames=0 biosdevname=0 \1"/g' /target/etc/default/grub;
    - sed -i 's/^#*\(send dhcp-client-identifier\).*$/\1 = hardware;/' /target/etc/dhcp/dhclient.conf;
    - find /target/etc/netplan/ -name "*.yaml" -exec sh -c 'mv "$1" "$1-orig"' _ {} \;
    - |
      cat <<EOF | sudo tee /target/etc/netplan/01-netcfg.yaml
      network:
        version: 2
        renderer: NetworkManager
        ethernets:
          eth0:
            dhcp4: true
            dhcp-identifier: mac
      EOF
    - |
      cat << EOF > /target/etc/cloud/cloud.cfg.d/05_logging.cfg
      _log:
       - &log_base |
         [loggers]
         keys=root,cloudinit
         [handlers]
         keys=consoleHandler,cloudLogHandler
         [formatters]
         keys=simpleFormatter,arg0Formatter
         [logger_root]
         level=DEBUG
         handlers=consoleHandler,cloudLogHandler
         [logger_cloudinit]
         level=DEBUG
         qualname=cloudinit
         handlers=
         propagate=1
         [handler_consoleHandler]
         class=StreamHandler
         level=WARNING
         formatter=arg0Formatter
         args=(sys.stderr,)
         [formatter_arg0Formatter]
         format=%(asctime)s - %(filename)s[%(levelname)s]: %(message)s
         [formatter_simpleFormatter]
         format=[CLOUDINIT] %(filename)s[%(levelname)s]: %(message)s
       - &log_file |
         [handler_cloudLogHandler]
         class=FileHandler
         level=DEBUG
         formatter=arg0Formatter
         args=('/var/log/cloud-init.log', 'a', 'UTF-8')
       - &log_syslog |
         [handler_cloudLogHandler]
         class=handlers.SysLogHandler
         level=DEBUG
         formatter=simpleFormatter
         args=("/dev/log", handlers.SysLogHandler.LOG_USER)
      log_cfgs:
       - [ *log_base, *log_file ]
         output: {all: '| tee -a /var/log/cloud-init-output.log'}
      EOF
    - |
      cat << EOF > /target/etc/cloud/cloud.cfg.d/90_dpkg.cfg
      # to update this file, run dpkg-reconfigure cloud-init
      datasource_list: [ AltCloud, VMware, NoCloud, None ]
      EOF
    - |
      cat << EOF > /target/etc/cloud/cloud.cfg.d/99-disable-network-config.cfg
      network: {config disbaled}
      EOF
    - curtin in-target --target /target netplan generate
    - curtin in-target --target /target netplan apply
    - curtin in-target --target /target systemctl enable NetworkManager.service
